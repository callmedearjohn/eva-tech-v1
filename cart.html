<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Cart - EVA Mats</title>
  <link rel="stylesheet" href="./static/css/style.min.css">
  <style>
    .cart { max-width: 960px; margin: 2rem auto; }
    .cart-item { display:grid; grid-template-columns: 80px 1fr 120px 120px 40px; gap:1rem; padding:.75rem 0; border-bottom:1px solid #eee; }
    .cart-item__img { width:80px; height:60px; object-fit:cover; border:1px solid #eee; border-radius:6px; }
    .cart-summary { text-align:right; margin-top:1rem; }
    .ship { display:flex; justify-content:flex-end; gap:1rem; align-items:center; margin-top:1rem; }
    .note { color:#666; font-size:14px; margin:.25rem 0 0; }
    .upsell { margin-top:1rem; padding:1rem; border:1px dashed #ccc; display:flex; flex-wrap:wrap; align-items:center; gap:1rem; justify-content:space-between; }
    .upsell__item { display:flex; align-items:center; gap:.5rem; }
    .upsell__thumb { width:56px; height:42px; object-fit:cover; border:1px solid #eee; border-radius:6px; }
    .recommend-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; width:100%; }
    .recommend-card { border:1px solid #eee; border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .recommend-card img { width:100%; height:140px; object-fit:cover; border-radius:8px; border:1px solid #eee; }
    .recommend-title { font-size:14px; line-height:1.3; color:#111; min-height:36px; }
    .recommend-price { display:flex; align-items:center; gap:8px; }
    .recommend-old { color:#999; text-decoration:line-through; font-size:14px; }
    .recommend-buy { display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:8px 14px; background:#ffcc33; color:#111; border-radius:8px; text-decoration:none; font-weight:600; }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="about-info">
        <a href="/" aria-label="Custom EVA mats for the interior of your car" class="logo about-info__logo">
          <img class="logo__image" src="./static/images/logo3_1.svg" loading="lazy" alt="Evacode logo">
        </a>
        <nav class="about-info__menu">
          <ul class="menu__nav-list">
            <li class="nav__list-item"><a href="#home" class="nav__list-link">Home</a></li>
            <li class="nav__list-item"><a href="about-product" class="nav__list-link">What is Eva?</a></li>
            <li class="nav__list-item"><a href="/#products" class="nav__list-link">Products</a></li>
            <li class="nav__list-item"><a href="warantly" class="nav__list-link">Warranty</a></li>
            <li class="nav__list-item"><a href="delivery" class="nav__list-link">Delivery</a></li>
            <li class="nav__list-item"><a href="about-us" class="nav__list-link">About us</a></li>
            <li class="nav__list-item"><a href="partners" class="nav__list-link">Partners</a></li>
          </ul>
          <div class="about-info__social">
            <a href="cart" class="about-info__link about-info__link-main" style="position:relative;">
              Cart
              <span style="position:absolute; top:-8px; right:-10px; background:#d42920; color:#fff; border-radius:12px; padding:2px 6px; font-size:12px;" data-cart-count>0</span>
            </a>
            <button class="social-btn social-btn-main">Contact Us
              <svg id="arow" width="12" height="7" viewBox="0 0 12 7" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M0 1.40051L5.96734 7.00272L6.00006 6.97063L6.031 7.00097L12 1.40051L10.5718 0.000421405L5.99867 4.2912L1.42778 0L0 1.40051Z" fill="white" />
              </svg>
            </button>
            <div class="social__list social__list-main fadeOut">
              <a aria-label="Custom EVA mats phone" href="tel:+16139857956" target="_blank" class="about-info__link about-info__text about-info__text-main">+1 613-214-1621</a>
              <a aria-label="Custom EVA mats gmail" href="mailto:info.evatech.ca@gmail.com" target="_blank" class="about-info__link about-info__text about-info__text-main">info.evatech.ca@gmail.com</a>
              <div class="about__info-icon">
                <a aria-label="Custom EVA mats facebook" href="https://www.facebook.com/people/VI-CarMats/61556124253098/?mibextid=sCpJLy" target="_blank" class="about-info__link about-info__link-main"><i class="icon-facebook"></i></a>
                <a aria-label="Custom EVA mats instagram" href="https://www.instagram.com/evatech.ca/" target="_blank" class="about-info__link about-info__link-main"><i class="icon-instagram"></i></a>
              </div>
            </div>
          </div>
        </nav>
        <img class="burger-btn" src="static/images/burgerBtn.svg" alt="" loading="lazy">
      </div>
    </div>
  </header>
  <div class="cart">
    <h1>Your Cart</h1>
    <div id="cart-list"></div>
    <div id="upsell" class="upsell">
      <div style="min-width:220px"><b>Recommend purchasing together</b><br><span class="note">Cheaper together</span></div>
      <!-- Keep hidden checkboxes for legacy totals logic (safe-guarded in JS) -->
      <label class="upsell__item" style="display:none"><input type="checkbox" id="addon-carsbag"> Carsbag M — <b>$45</b></label>
      <label class="upsell__item" style="display:none"><input type="checkbox" id="addon-home"> Home M mat — <b>$25</b></label>
      <div class="recommend-grid">
        <div class="recommend-card">
          <img src="./static/images/car-bags/bag-1.jpg" alt="Cars Bags">
          <div class="recommend-title">Cars Bag (M)</div>
          <div class="recommend-price"><strong>$45</strong> <span class="recommend-old">$49</span></div>
          <div><a class="recommend-buy" href="/configurator?product=carsbag">BUY</a></div>
        </div>
        <div class="recommend-card">
          <img src="./static/images/home-mats/mat-1.jpg" alt="Home Mats">
          <div class="recommend-title">Home Mat (M)</div>
          <div class="recommend-price"><strong>$25</strong> <span class="recommend-old">$29</span></div>
          <div><a class="recommend-buy" href="/configurator?product=home">BUY</a></div>
        </div>
      </div>
    </div>
    <div class="cart-summary">
      <p class="total-text">Subtotal: <span id="cart-subtotal">0</span>$</p>
      <div class="ship">
        <label for="ship-country">Ship to:</label>
        <select id="ship-country" class="select constructor-step__select constructor-step__control form-control select__arow" style="max-width:240px">
          <option value="CA" selected>Canada</option>
          <option value="ROW">Rest of World</option>
        </select>
        <span>Shipping: <b><span id="ship-price">0</span>$</b></span>
      </div>
      <p id="cart-freeship" style="display:none">Free Shipping in Canada</p>
      <p id="ship-note" class="note" style="display:none">Orders under $100 before tax ship for a flat $22 within Canada.</p>
      <p class="total-text">Tax (13%): <span id="cart-tax">0</span>$</p>
      <p class="total-text">Total: <span id="cart-total">0</span>$</p>
      <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
        <a href="/configurator" class="button">Continue shopping</a>
        <div id="paypal-button-container" style="min-width:200px"></div>
      </div>
    </div>
  </div>
  <footer class="footer">
    <div class="about-info">
      <a href="/" aria-label="Custom EVA mats for the interior of your car" class="logo about-info__logo">
        <img class="logo__image" src="/static/images/logo3_1.svg" loading="lazy" alt="Evacode logo">
      </a>
      <div class="about-info__social">
        <a aria-label="Custom EVA mats facebook" href="https://www.facebook.com/people/VI-CarMats/61556124253098/?mibextid=sCpJLy" target="_blank" class="about-info__link about-info__link-main"><i class="icon-facebook"></i></a>
        <a aria-label="Custom EVA mats instagram" href="https://www.instagram.com/evatech.ca" target="_blank" class="about-info__link about-info__link-main"><i class="icon-instagram"></i></a>
        <a aria-label="Custom EVA mats gmail" href="mailto:info.evatech.ca@gmail.com" target="_blank" class="about-info__link about-info__text-main"><i class="icon-mail"></i> info.evatech.ca@gmail.com</a>
        <a aria-label="Custom EVA mats phone" href="tel:+16139857956" target="_blank" class="about-info__link about-info__text-main"><i class="icon-call-in"></i> +1 613-214-1621</a>
        <p class="about-info__text about-info__text-main about-info__location">Our Location: Kingston, ON</p>
      </div>
    </div>
  </footer>
  <div class="header__menu-mobile">
    <div class="header__menu-top">
      <a href="/" aria-label="Custom EVA mats for the interior of your car" class="logo header__menu-logo">
        <img loading="lazy" src="static/images/logo2 1.svg" alt="Evacode logo">
      </a>
      <img class="close-btn" src="static/images/xmark-solid.svg" loading="lazy" alt="">
    </div>
    <nav class="header__menu-nav">
      <ul class="header__menu-items">
        <li class="header__menu-item"><a href="#home">Home</a></li>
        <li class="header__menu-item"><a href="about-product">What is Eva?</a></li>
        <li class="header__menu-item"><a href="/#products">Products</a></li>
        <li class="header__menu-item"><a href="warantly">Warranty</a></li>
        <li class="header__menu-item"><a href="delivery">Delivery</a></li>
        <li class="header__menu-item"><a href="about-us">About us</a></li>
        <li class="header__menu-item"><a href="partners">Partners</a></li>
      </ul>
      <div class="header__menu-social">
        <div class="header__menu-icon">
          <a aria-label="Custom EVA mats facebook" href="https://www.facebook.com/people/VI-CarMats/61556124253098/?mibextid=sCpJLy" target="_blank" class="header_menu-link"><i class="icon-facebook"></i></a>
          <a aria-label="Custom EVA mats instagram" href="https://www.instagram.com/evatech.ca/" target="_blank" class="header_menu-link"><i class="icon-instagram"></i></a>
        </div>
        <a aria-label="Custom EVA mats phone" href="tel:+16139857956" target="_blank" class="header_menu-link about-info__text-main">+1 613-214-1621</a>
        <a aria-label="Custom EVA mats gmail" href="mailto:info.evatech.ca@gmail.com" target="_blank" class="header_menu-link about-info__text-main">info.evatech.ca@gmail.com</a>
        <p class="header_menu-text">Our Location: Kingston, ON</p>
      </div>
    </nav>
  </div>
  <script src="static/js/dist/burger.bundle.js"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=AaBE5ZhNo7yifhXrlvBV1Qr2vfe1CU86vXfKxnFp_apuhzhXaf0BHhvimPaZzrYXcpCQ1nYqIKSEqc0G&currency=CAD"></script>
  <script type="module">
    import { Cart } from './static/js/cart.js';
    const listEl = document.getElementById('cart-list');
    const countryEl = document.getElementById('ship-country');
    const shipPriceEl = document.getElementById('ship-price');
    const totalEl = document.getElementById('cart-total');
    const taxEl = document.getElementById('cart-tax');
    let taxCfg = { type:'percent', value:0 };
    try { const r = await fetch('static/data/tax.json'); taxCfg = await r.json(); } catch(_){ }
    const addonCarsbagEl = document.getElementById('addon-carsbag');
    const addonHomeEl = document.getElementById('addon-home');
    const ADDON_CARSBAG_PRICE = 45;
    const ADDON_HOME_PRICE = 25;
    const FREE_SHIP_THRESHOLD = 100;
    function render(){
      const items = Cart.list();
      listEl.innerHTML = '';
      items.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className='cart-item';
        const imgSrc = it.product === 'carsbag' ? './static/images/car-bags/bag-1.jpg' : (it.product === 'home' ? './static/images/home-mats/mat-1.jpg' : `./static/images/price-constructor/color-combinations/${it.matColor}-${it.trimColor||it.matColor}.jpg`);
        const title = `${it.make||''} ${it.model||''} ${it.year||''}`.trim();
        const isSimple = it.product === 'carsbag' || it.product === 'home';
        const sizeMap = it.product === 'carsbag' ? { front:'M', full:'L' } : { front:'S', full:'M', complete:'L', xl:'XL' };
        const productName = it.product === 'carsbag' ? 'Cars Bag' : (it.product === 'home' ? 'Home Mat' : 'EVA Car Mats');
        const detail = isSimple
          ? `${productName} — Size: ${sizeMap[it.set] || it.set} | Color: ${it.matColor || '—'}`
          : `${title || productName} — ${it.set} | ${it.pattern} | ${it.matColor}/${it.trimColor||it.matColor} ${it.thirdRow ? '| 3rd row' : ''} ${it.heelPad ? '| heel pad' : ''}`;
        row.innerHTML = `
          <div><img class="cart-item__img" src="${imgSrc}" alt="${productName}"></div>
          <div>${detail}</div>
          <div>${(it.subtotal||0)}$</div>
          <div><input type="number" min="1" value="${it.qty||1}" style="width:80px"></div>
          <div><button data-rm>×</button></div>`;
        row.querySelector('input').addEventListener('change', (e)=>{ Cart.update(idx, +e.target.value||1); render(); });
        row.querySelector('[data-rm]').addEventListener('click', ()=>{ Cart.remove(idx); render(); });
        listEl.appendChild(row);
      });
      // Hide upsell if both Cars Bag and Home Mat are already in cart
      const hasCarsbag = items.some(i=> i.product === 'carsbag');
      const hasHome = items.some(i=> i.product === 'home');
      const upsell = document.getElementById('upsell');
      if (upsell) {
        if (hasCarsbag && hasHome) {
          // clear add-on checkboxes to avoid affecting totals
          if (addonCarsbagEl) addonCarsbagEl.checked = false;
          if (addonHomeEl) addonHomeEl.checked = false;
          upsell.style.display = 'none';
        } else {
          upsell.style.display = '';
        }
      }
      const subtotal = Cart.total();
      document.getElementById('cart-subtotal').textContent = subtotal;
      const country = countryEl.value;
      const addonsTotal = (addonCarsbagEl.checked? ADDON_CARSBAG_PRICE : 0) + (addonHomeEl.checked? ADDON_HOME_PRICE : 0);
      const shipping = country === 'CA' && (subtotal + addonsTotal) >= FREE_SHIP_THRESHOLD ? 0 : 22;
      shipPriceEl.textContent = shipping;
      let tax = 0;
      if (taxCfg.type === 'percent') tax = +(((subtotal + addonsTotal) * (taxCfg.value||0) / 100)).toFixed(2);
      const total = subtotal + addonsTotal + shipping + tax;
      totalEl.textContent = total;
      if (taxEl) taxEl.textContent = tax;
      const free = (country === 'CA' && (subtotal + addonsTotal) >= FREE_SHIP_THRESHOLD);
      document.getElementById('cart-freeship').style.display = free ? 'block' : 'none';
      const shipNote = document.getElementById('ship-note');
      shipNote.style.display = free ? 'none' : 'block';
    }
    countryEl.addEventListener('change', render);
    addonCarsbagEl.addEventListener('change', render);
    addonHomeEl.addEventListener('change', render);
    // No one-click or manual checkout – use PayPal directly
    render();
    // PayPal button
    if (window.paypal) {
      paypal.Buttons({
        createOrder: function(data, actions) {
          const items = Cart.list();
          const subtotal = +document.getElementById('cart-subtotal').textContent;
          const shipping = +shipPriceEl.textContent;
          const addons = [];
          if (addonCarsbagEl.checked) addons.push({ name:'Carsbag M', price: ADDON_CARSBAG_PRICE });
          if (addonHomeEl.checked) addons.push({ name:'Home M mat', price: ADDON_HOME_PRICE });
          const addonsTotal = addons.reduce((s,a)=> s + a.price, 0);
          const tax = +( (((subtotal + addonsTotal) * (taxCfg.value||0)) / 100).toFixed(2) );
          const total = subtotal + addonsTotal + shipping + tax;
          return actions.order.create({
            purchase_units: [{
              amount: { value: total.toFixed(2), currency_code: 'CAD',
                breakdown: {
                  item_total: { value: (subtotal + addonsTotal).toFixed(2), currency_code: 'CAD' },
                  shipping: { value: shipping.toFixed(2), currency_code: 'CAD' },
                  tax_total: { value: tax.toFixed(2), currency_code: 'CAD' }
                }
              },
              items: items.map(i=>({
                name: `${i.make} ${i.model} ${i.year} — ${i.set}`.slice(0,127),
                unit_amount: { value: (i.subtotal||0).toFixed(2), currency_code: 'CAD' },
                quantity: String(i.qty||1)
              })).concat(addons.map(a=>({ name: a.name, unit_amount:{ value: a.price.toFixed(2), currency_code:'CAD' }, quantity:'1' })))
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(async function(details) {
            const items = Cart.list();
            const subtotal = +document.getElementById('cart-subtotal').textContent;
            const shipping = +shipPriceEl.textContent;
            const addons = [];
            if (addonCarsbagEl.checked) addons.push({ name:'Carsbag M', price: ADDON_CARSBAG_PRICE });
            if (addonHomeEl.checked) addons.push({ name:'Home M mat', price: ADDON_HOME_PRICE });
            const addonsTotal = addons.reduce((s,a)=> s + a.price, 0);
            const tax = +( (((subtotal + addonsTotal) * (taxCfg.value||0)) / 100).toFixed(2) );
            const total = subtotal + addonsTotal + shipping + tax;
            const phone = prompt('Phone number for delivery (optional):') || '';
            const payload = {
              formName:'paypal',
              paypalOrderId: details.id,
              payerEmail: details.payer?.email_address || '',
              payerName: `${details.payer?.name?.given_name||''} ${details.payer?.name?.surname||''}`.trim(),
              shipTo: {
                name: details.purchase_units?.[0]?.shipping?.name?.full_name || '',
                line1: details.purchase_units?.[0]?.shipping?.address?.address_line_1 || '',
                line2: details.purchase_units?.[0]?.shipping?.address?.address_line_2 || '',
                city: details.purchase_units?.[0]?.shipping?.address?.admin_area_2 || '',
                state: details.purchase_units?.[0]?.shipping?.address?.admin_area_1 || '',
                postal: details.purchase_units?.[0]?.shipping?.address?.postal_code || '',
                country: details.purchase_units?.[0]?.shipping?.address?.country_code || ''
              },
              items, subtotal, shipping, addons, addonsTotal, tax, total, phone
            };
            try { await fetch('action.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } catch(_){ }
            alert('Payment captured. Thank you!');
          });
        }
      }).render('#paypal-button-container');
    }
  </script>
</body>
</html>


