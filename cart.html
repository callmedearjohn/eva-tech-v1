<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Cart - EVA Mats</title>
  <link rel="stylesheet" href="./static/css/style.min.css">
  <link rel="stylesheet" href="./static/css/custom.css?v=20250925">
  <style>
    .cart { max-width: 1200px; margin: 2rem auto; }
    .wrapper { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
    .crumble { color:#666; margin: 8px 0 16px; }
    .crumble a { color: inherit; text-decoration: none; }
    .checkout_process_path { display:flex; gap:10px; list-style:none; padding:0; margin: 8px 0 16px; color:#666; }
    .checkout_process_path li.active { color:#111; font-weight:700; }
    .basket_wrapper { display:grid; grid-template-columns: 1.6fr .9fr; gap: 24px; align-items:start; }
    .basket-table { width:100%; border-collapse: collapse; }
    .basket-table th, .basket-table td { text-align:left; border-bottom:1px solid #eee; padding:12px 8px; vertical-align:middle; }
    .basket-table th { color:#666; font-weight:700; }
    .basket_img { position:relative; width:96px; height:72px; border:1px solid #eee; border-radius:8px; overflow:hidden; }
    .basket_img img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    .bnameim { display:flex; gap:12px; align-items:center; }
    .desc_wrapper { display:flex; gap:14px; margin-top:6px; font-size:14px; color:#444; }
    .basketcolor { display:inline-block; width:14px; height:14px; border-radius:50%; border:1px solid #ddd; vertical-align:middle; }
    .counter { display:inline-flex; align-items:center; border:1px solid #ddd; border-radius:8px; padding:4px; gap:10px; }
    .counter .minus, .counter .plus { cursor:pointer; user-select:none; font-weight:700; width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; background:#f4f4f4; border-radius:6px; }
    .counter .count { min-width:20px; display:inline-block; text-align:center; }
    .newsf .strong { font-weight:800; }
    .s { position:sticky; top:20px; }
    .addpromo_wrapper { display:flex; gap:8px; margin:10px 0; }
    .addpromo_wrapper input[type="text"]{ flex:1 1 auto; height:38px; padding:0 10px; }
    .addpromo_wrapper button { height:38px; padding:0 14px; border:0; background:#ffcc33; border-radius:8px; cursor:pointer; font-weight:700; }
    .basket_explain { border-top:1px solid #eee; margin-top:8px; }
    .basket_explain > div { display:flex; justify-content:space-between; margin:8px 0; }
    .btn_mo .button { display:block; text-align:center; }
    .near_goods { margin-top:28px; }
    .catalog__list { display:flex; gap:16px; margin-top:16px; }
    .catalog__item { border:1px solid #eee; border-radius:10px; padding:12px; }
    .deltd { text-align:center; }
    .icon-remove { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; background:#f4f4f4; border-radius:6px; color:#d42920; text-decoration:none; cursor:pointer; }
    .icon-remove svg { width:16px; height:16px; display:block; }
    .icon-remove:hover { background:#ffe5e5; }
    /* Ensure social dropdown is truly non-interactive when hidden */
    .social__list.fadeOut { display: none; pointer-events: none; }
    .social__list.fadeIn { display: block; pointer-events: auto; }
    /* Inline validation visuals (shared across inputs/labels) */
    .cart-invalid { outline: 2px solid #d93025 !important; border-color: #d93025 !important; color:#d93025 !important; }
    @keyframes cart-shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
    .cart-shake { animation: cart-shake .4s ease; }
    /* Full-screen loader */
    .global-loader { position: fixed; inset: 0; background: rgba(255,255,255,.85); display: none; align-items: center; justify-content: center; z-index: 99999; }
    .loader-spinner { width: 64px; height: 64px; border: 4px solid #e5e5e5; border-top-color: #ffcc33; border-radius: 50%; animation: cart-spin 1s linear infinite; }
    @keyframes cart-spin { to { transform: rotate(360deg); } }
    @media (max-width: 900px){ .basket_wrapper { grid-template-columns: 1fr; } .s{ position:static; } }
    @media (max-width: 720px){
      .basket-table, .basket-table thead, .basket-table tbody, .basket-table tr, .basket-table th, .basket-table td { display:block; width:100%; }
      .basket-table tr.yeallow { display:none; }
      .basket-table tr { border-bottom:8px solid #f7f7f7; }
      .basket-table td { border:0; padding:8px 0; }
      .bnameim { align-items:flex-start; }
      .deltd { text-align:left; }
      .catalog__list { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="about-info">
        <a href="/" aria-label="Custom EVA mats for the interior of your car" class="logo about-info__logo">
          <img class="logo__image" src="./static/images/logo3_1.svg" loading="lazy" alt="Evacode logo">
        </a>
        <nav class="about-info__menu">
          <ul class="menu__nav-list">
            <li class="nav__list-item"><a href="/" class="nav__list-link">Home</a></li>
            <li class="nav__list-item"><a href="about-product" class="nav__list-link">What is Eva?</a></li>
            <li class="nav__list-item"><a href="/#products" class="nav__list-link">Products</a></li>
            <li class="nav__list-item"><a href="warantly" class="nav__list-link">Warranty</a></li>
            <li class="nav__list-item"><a href="delivery" class="nav__list-link">Delivery</a></li>
            <li class="nav__list-item"><a href="about-us" class="nav__list-link">About us</a></li>
            <li class="nav__list-item"><a href="partners" class="nav__list-link">Partners</a></li>
          </ul>
          <div class="about-info__social">
            <a href="cart" class="cart-link about-info__link-main" aria-label="Cart">
              <svg class="cart-link__icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zM7.17 14h9.66c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0 0 21.33 5H6.21l-.94-2H2v2h2l3.6 7.59-1.35 2.45C5.52 15.37 6.48 17 8 17h12v-2H8l1.1-2z"/></svg>
              <span class="cart-link__badge" data-cart-count>0</span>
            </a>
            <button class="social-btn social-btn-main" type="button">Contact Us
              <svg id="arow" width="12" height="7" viewBox="0 0 12 7" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M0 1.40051L5.96734 7.00272L6.00006 6.97063L6.031 7.00097L12 1.40051L10.5718 0.000421405L5.99867 4.2912L1.42778 0L0 1.40051Z" fill="white" />
              </svg>
            </button>
            <div class="social__list fadeOut">
              <a aria-label="Custom EVA mats phone" href="tel:+16139857956" target="_blank" class="about-info__link about-info__text">+1 613-214-1621</a>
              <a aria-label="Custom EVA mats gmail" href="mailto:info.evatech.ca@gmail.com" target="_blank" class="about-info__link about-info__text">info.evatech.ca@gmail.com</a>
              <div class="about__info-icon">
                <a aria-label="Custom EVA mats facebook" href="https://www.facebook.com/people/VI-CarMats/61556124253098/?mibextid=sCpJLy" target="_blank" class="about-info__link"><i class="icon-facebook"></i></a>
                <a aria-label="Custom EVA mats instagram" href="https://www.instagram.com/evatech.ca/" target="_blank" class="about-info__link"><i class="icon-instagram"></i></a>
              </div>
            </div>
          </div>
        </nav>
        <div class="header__actions">
          <a href="cart" class="mobile-cart cart-link" aria-label="Cart">
            <svg class="cart-link__icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zM7.17 14h9.66c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0 0 21.33 5H6.21l-.94-2H2v2h2l3.6 7.59-1.35 2.45C5.52 15.37 6.48 17 8 17h12v-2H8l1.1-2z"/></svg>
            <span class="cart-link__badge" data-cart-count>0</span>
          </a>
          <img class="burger-btn" src="static/images/burgerBtn.svg" alt="" loading="lazy">
        </div>
      </div>
    </div>
  </header>
  <div class="cart">
    <!-- <div class=""><div class="crumble"><a href="/">Home</a> / Cart</div></div> -->
    <div class="maincontent basket">
      <div class="site">
        <div class="wrapper">
          <h1>Cart</h1>
          <!-- <ul class="checkout_process_path">
            <li class="active">Cart</li><li>/</li>
            <li class="">Shipping</li><li>/</li>
            <li class="">Complete (payment)</li>
          </ul> -->
          <div id="basketcontent"><div class="basket_wrapper">
            <div class="f">
              <table class="basket-table">
                <tr class="yeallow"><th>Product</th><th>Quantity</th><th>Total</th><th>Delete</th></tr>
                <tbody id="basket-rows"></tbody>
              </table>
            </div>
            <div class="s">
              <img src="https://www.fortunacarmats.com/images/freeshipping.jpg" style="width: 100%;max-width: 390px;">
              <div class="mkeorder_wrapper">
                <div id="promocode">
                  <div>
                    <form class="addpromo_wrapper" onsubmit="return false;">
                      <input id="promo-code" type="text" name="promocode" value="" placeholder="Discount code"><button id="apply-promo" class="applypromo">Apply</button>
                    </form>
                  </div>
                </div>
                <div class="basket_explain">
                  <div><span>Shipping</span><span>$<span id="ship-price">0</span></span></div>
                  <div><span>Discount</span><span>$<span id="cart-discount">0</span></span></div>
                  <div><span>Tax</span><span>$<span id="cart-tax">0</span></span></div>
                  <div><span>Total</span><span>$<span id="cart-total">0</span></span></div>
                </div>
                <div style="margin-top:12px">
                  <label id="agreement-label" style="display:inline-flex; align-items:center; gap:6px; font-size:14px;">
                    <input type="checkbox" id="agree-terms"> I agree to the <a href="privacyPolicy">Terms and Conditions</a>
                  </label>
                </div>
                <div style="margin-top:12px"><div id="paypal-button-container"></div></div>
                <dialog id="terms-dialog" style="max-width:720px; width:90%; padding:16px 18px; border:1px solid #e5e5e5; border-radius:10px;">
                  <h3 style="margin:0 0 10px;">Terms and Conditions</h3>
                  <div style="max-height:50vh; overflow:auto; color:#333; font-size:14px; line-height:1.55;">
                    <p>By placing an order on our website, you agree to EVATECH’s Terms and Conditions. Our products are custom-made; order acceptance occurs when we email a confirmation that we can produce your specific set. If we cannot produce your set, we will cancel and refund in full.</p>
                    <p>Shipping within Canada: Orders of $100 or more (before tax) ship free via standard ground. Orders under $100 (before tax) are charged at the rate shown at checkout.</p>
                    <p>Warranty: We provide a 1-year warranty against defects in materials and workmanship under normal use. Misuse, improper installation, and abnormal wear are not covered.</p>
                    <p>Full terms, including Title & Risk and Delivery Confirmation, are available on our <a href="privacyPolicy#terms">Terms and Conditions</a> page.</p>
                  </div>
                  <div style="text-align:right; margin-top:12px;"><button id="close-terms" class="button button-gray">Close</button></div>
                </dialog>
                <p id="cart-freeship" style="display:none; margin-top:8px;">Free Shipping in Canada</p>
                <p id="ship-note" class="note" style="display:none">Orders under $100 before tax ship for a flat $22 within Canada.</p>
              </div>
            </div>
          </div></div>
          <div class=""><div class="near_goods"><h3>Recommend purchasing together </h3>
            <div class="catalog__list">
              <div class="catalog__item">
                <div class="catalog__item-wrapper">
                  <a class="catalog__item-img" href="/configurator?product=carsbag">
                    <img src="./static/images/car-bags/bag-1.jpg" alt="Cars Bag" style="width:100%; height:140px; object-fit:cover; border-radius:8px; border:1px solid #eee;">
                  </a>
                  <div class="catalog__item-text">Cars Bag (M)</div>
                  <div class="btn_prices"><div class="catalog__item-price"><span>$45</span> <del>$49</del></div>
                    <div class="btn_wrapperx"><a href="/configurator?product=carsbag" class="button button-gray"><span class="text">Buy</span></a></div>
                  </div>
                </div>
              </div>
              <div class="catalog__item">
                <div class="catalog__item-wrapper">
                  <a class="catalog__item-img" href="/configurator?product=home">
                    <img src="./static/images/home-mats/mat-1.jpg" alt="Home Mat" style="width:100%; height:140px; object-fit:cover; border-radius:8px; border:1px solid #eee;">
                  </a>
                  <div class="catalog__item-text">Home Mat (M)</div>
                  <div class="btn_prices"><div class="catalog__item-price"><span>$25</span> <del>$29</del></div>
                    <div class="btn_wrapperx"><a href="/configurator?product=home" class="button button-gray"><span class="text">Buy</span></a></div>
                  </div>
                </div>
              </div>
            </div>
          </div></div>
        </div>
      </div>
    </div>
  </div>
  <footer class="footer">
    <div class="about-info">
      <a href="/" aria-label="Custom EVA mats for the interior of your car" class="logo about-info__logo">
        <img class="logo__image" src="/static/images/logo3_1.svg" loading="lazy" alt="Evacode logo">
      </a>
      <div class="about-info__social">
        <a aria-label="Custom EVA mats facebook" href="https://www.facebook.com/people/VI-CarMats/61556124253098/?mibextid=sCpJLy" target="_blank" class="about-info__link about-info__link-main"><i class="icon-facebook"></i></a>
        <a aria-label="Custom EVA mats instagram" href="https://www.instagram.com/evatech.ca" target="_blank" class="about-info__link about-info__link-main"><i class="icon-instagram"></i></a>
        <a aria-label="Custom EVA mats gmail" href="mailto:info.evatech.ca@gmail.com" target="_blank" class="about-info__link about-info__text-main"><i class="icon-mail"></i> info.evatech.ca@gmail.com</a>
        <a aria-label="Custom EVA mats phone" href="tel:+16139857956" target="_blank" class="about-info__link about-info__text-main"><i class="icon-call-in"></i> +1 613-214-1621</a>
        <p class="about-info__text about-info__text-main about-info__location">Our Location: Kingston, ON</p>
      </div>
    </div>
  </footer>
  <!-- Global loader overlay -->
  <div id="global-loader" class="global-loader" aria-hidden="true" role="status" aria-live="polite">
    <div class="loader-spinner" aria-label="Loading"></div>
  </div>
  <!-- Success modal -->
  <dialog id="success-dialog" style="max-width:520px; width:90%; padding:18px 18px; border:1px solid #e5e5e5; border-radius:10px;">
    <h3 style="margin:0 0 10px;">Thank you for your order!</h3>
    <p style="margin:0; color:#333;">Your payment has been captured successfully.</p>
    <p style="margin:8px 0 0; color:#333;">A confirmation email has been sent to <strong><span id="success-email">your email</span></strong>.</p>
    <ul style="margin:12px 0 16px 18px; color:#333; line-height:1.5;">
      <li>We’ll start processing your order right away.</li>
      <li>Tracking details will be emailed once your order ships.</li>
      <li>If you have questions, contact us at <a href="mailto:info.evatech.ca@gmail.com">info.evatech.ca@gmail.com</a> or <a href="tel:+16139857956">+1 613-214-1621</a>.</li>
    </ul>
    <div style="display:flex; gap:8px; justify-content:flex-end; align-items:center;">
      <a href="/" class="button">Continue shopping</a>
      <button id="close-success" class="button button-gray">Close</button>
    </div>
  </dialog>
  <div class="header__menu-mobile">
    <div class="header__menu-top">
      <a href="/" aria-label="Custom EVA mats for the interior of your car" class="logo header__menu-logo">
        <img loading="lazy" src="static/images/logo2 1.svg" alt="Evacode logo">
      </a>
      <img class="close-btn" src="static/images/xmark-solid.svg" loading="lazy" alt="">
    </div>
    <nav class="header__menu-nav">
      <ul class="header__menu-items">
        <li class="header__menu-item"><a href="/">Home</a></li>
        <li class="header__menu-item"><a href="about-product">What is Eva?</a></li>
        <li class="header__menu-item"><a href="/#products">Products</a></li>
        <li class="header__menu-item"><a href="warantly">Warranty</a></li>
        <li class="header__menu-item"><a href="delivery">Delivery</a></li>
        <li class="header__menu-item"><a href="about-us">About us</a></li>
        <li class="header__menu-item"><a href="partners">Partners</a></li>
      </ul>
      <div class="header__menu-social">
        <div class="header__menu-icon">
          <a aria-label="Custom EVA mats facebook" href="https://www.facebook.com/people/VI-CarMats/61556124253098/?mibextid=sCpJLy" target="_blank" class="header_menu-link"><i class="icon-facebook"></i></a>
          <a aria-label="Custom EVA mats instagram" href="https://www.instagram.com/evatech.ca/" target="_blank" class="header_menu-link"><i class="icon-instagram"></i></a>
        </div>
        <a aria-label="Custom EVA mats phone" href="tel:+16139857956" target="_blank" class="header_menu-link about-info__text-main">+1 613-214-1621</a>
        <a aria-label="Custom EVA mats gmail" href="mailto:info.evatech.ca@gmail.com" target="_blank" class="header_menu-link about-info__text-main">info.evatech.ca@gmail.com</a>
        <p class="header_menu-text">Our Location: Kingston, ON</p>
      </div>
    </nav>
  </div>
  <script src="static/js/dist/burger.bundle.js"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=Ae-VME1jRdWllXfLel7OVb-Im0CmMH0xol6anidkA0_EV4nCxogtoCMfbA5bqDkh-zHiwbaODYMAVzVH&currency=CAD"></script>
  <script defer src="static/js/cart-badge.js"></script>
  <script type="module">
    import { Cart } from './static/js/cart.js';
    const rowsEl = document.getElementById('basket-rows');
    const shipPriceEl = document.getElementById('ship-price');
    const totalEl = document.getElementById('cart-total');
    const discountEl = document.getElementById('cart-discount');
    const taxEl = document.getElementById('cart-tax');
    const promoInput = document.getElementById('promo-code');
    const applyPromoBtn = document.getElementById('apply-promo');
    const paypalContainer = document.getElementById('paypal-button-container');
    let taxCfg = { type:'percent', value:0 };
    try { const r = await fetch('static/data/tax.json'); taxCfg = await r.json(); } catch(_){ }
    const ADDON_CARSBAG_PRICE = 45;
    const ADDON_HOME_PRICE = 25;
    const FREE_SHIP_THRESHOLD = 100;
    let discountPercent = 0; // applied promo discount (percent)
    let appliedPromo = '';

    // Map UI colors to asset filenames (same mapping as configurator)
    function getMatAssetKey(color){
      const n = String(color || '').toLowerCase();
      const map = { 'black':'black', 'gray':'gray', 'grey':'gray', 'beige':'beg', 'brown':'brown', 'blue':'blue', 'red':'red', 'orange':'red' };
      return map[n] || '';
    }
    function getTrimAssetKey(color){
      const n = String(color || '').toLowerCase();
      const map = { 'black':'black', 'light-grey':'lightgray', 'grey':'darkgray', 'gray':'darkgray', 'orange':'orange', 'red':'red', 'blue':'blue', 'yellow':'yellow', 'velvet':'black' };
      return map[n] || '';
    }
    function normalizeText(s){
      try {
        return String(s)
          .replace(/â€”/g, '—')
          .replace(/â€“/g, '–')
          .replace(/â€™/g, '’')
          .replace(/â€˜/g, '‘')
          .replace(/â€œ/g, '“')
          .replace(/â€�/g, '”')
          .replace(/Â\s/g, ' ');
      } catch(_) { return s; }
    }
    function escapeHtml(s){
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#39;');
      } catch(_) { return s; }
    }
    function render(){
      const items = Cart.list();
      rowsEl.innerHTML = '';
      // Empty-cart UX: show message and block checkout/payment
      if (!items.length) {
        rowsEl.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:24px 8px; color:#666;">Your cart is empty. <a href="/configurator">Build your mats</a> or <a href="/">continue shopping</a>.</td></tr>';
        shipPriceEl.textContent = '0';
        if (discountEl) discountEl.textContent = '0';
        if (taxEl) taxEl.textContent = '0';
        totalEl.textContent = '0.00';
        try { document.getElementById('cart-freeship').style.display = 'none'; } catch(_){ }
        try { document.getElementById('ship-note').style.display = 'none'; } catch(_){ }
        try { paypalContainer && (paypalContainer.style.display = 'none'); } catch(_){ }
        try { if (window.updateCartBadge) window.updateCartBadge(); } catch(_){}
        return;
      } else {
        try { paypalContainer && (paypalContainer.style.display = ''); } catch(_){ }
      }
      items.forEach((it, idx)=>{
        const tr = document.createElement('tr');
        const imgSrc = it.product === 'carsbag' ? './static/images/car-bags/bag-1.jpg' : (it.product === 'home' ? './static/images/home-mats/mat-1.jpg' : `./static/images/price-constructor/color-combinations/${it.matColor}-${it.trimColor||it.matColor}.jpg`);
        const title = `${it.make||''} ${it.model||''} ${it.year||''}`.trim();
        const isSimple = it.product === 'carsbag' || it.product === 'home';
        const sizeMap = it.product === 'carsbag' ? { front:'M', full:'L' } : { front:'S', full:'M', complete:'L', xl:'XL' };
        const productName = it.product === 'carsbag' ? 'Cars Bag' : (it.product === 'home' ? 'Home Mat' : 'EVA Car Mats');
        const detailRaw = isSimple
          ? `${productName} — Size: ${sizeMap[it.set] || it.set} | Color: ${it.matColor || '—'} / ${it.trimColor || it.matColor || '—'}`
          : `${title || productName} — ${it.set} | ${it.pattern} | ${it.matColor}/${it.trimColor||it.matColor} ${it.thirdRow ? '| 3rd row' : ''} ${it.heelPad ? '| heel pad' : ''} ${it.hybrid ? '| hybrid' : ''}`;
        const detail = escapeHtml(normalizeText(detailRaw));
        const colorDot = it.matColor ? `<span class="basketcolor" style="background:${it.matColor}"></span>` : '';
        const trimDot = it.trimColor ? `<span class="basketcolor" style="background:${it.trimColor}"></span>` : '';
        // Build layered image preview for car mats when available; fallback to combo photo
        let imgHtml = '';
        if (!isSimple) {
          const matKey = getMatAssetKey(it.matColor);
          const trimKey = getTrimAssetKey(it.trimColor || it.matColor);
          const matLayerSrc = matKey ? `./static/images/price-constructor/mats/${matKey}.png` : '';
          const trimLayerSrc = trimKey ? `./static/images/price-constructor/trims/${trimKey}.png` : '';
          if (matLayerSrc || trimLayerSrc) {
            imgHtml = `<div class="basket_img">${matLayerSrc?`<img src="${matLayerSrc}" alt="${productName} mat">`:''}${trimLayerSrc?`<img src="${trimLayerSrc}" alt="${productName} trim">`:''}</div>`;
          } else {
            imgHtml = `<div class=\"basket_img\"><img src=\"${imgSrc}\" alt=\"${productName}\"></div>`;
          }
        } else {
          imgHtml = `<div class=\"basket_img\"><img src=\"${imgSrc}\" alt=\"${productName}\"></div>`;
        }
        tr.innerHTML = `
          <td>
            <div class="bnameim">
              <div>${imgHtml}</div>
              <div>${detail}<br>
                <div class="desc_wrapper"><span class="opt_desc"><span>Colour:</span> ${colorDot}</span><span class="opt_desc"><span>Edging colour:</span> ${trimDot || colorDot}</span></div>
              </div>
            </div>
          </td>
          <td rel="${idx}">
            <div class="counter"><span class="minus" data-dec>-</span><span><span class="count">${it.qty||1}</span></span><span class="plus" data-inc>+</span></div>
          </td>
          <td class="pricetd"><div class="newsf"><span class="strong"> <span>$</span>&nbsp;${(((it.subtotal||0) * (it.qty||1)).toFixed(0))}</span></div></td>
          <td class="deltd"><a href="javascript:void(0)" class="icon-remove" title="Remove" data-rm>
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12l-1 14H7L6 7Zm3-3h6l1 2H8l1-2Zm-4 2h14v2H5V6Z" fill="currentColor"/></svg>
          </a></td>
        `;
        tr.querySelector('[data-inc]').addEventListener('click', ()=>{ Cart.update(idx, (it.qty||1) + 1); render(); });
        tr.querySelector('[data-dec]').addEventListener('click', ()=>{ const q=(it.qty||1)-1; Cart.update(idx, q<1?1:q); render(); });
        tr.querySelector('[data-rm]').addEventListener('click', ()=>{ Cart.remove(idx); render(); });
        rowsEl.appendChild(tr);
      });
      const subtotal = Cart.total();
      const addonsTotal = 0; // no add-on checkboxes in this layout
      // Canada only
      const shipping = (subtotal + addonsTotal) >= FREE_SHIP_THRESHOLD ? 0 : 22;
      shipPriceEl.textContent = shipping;
      let tax = 0;
      const preDiscount = subtotal + addonsTotal;
      if (taxCfg.type === 'percent') tax = +((preDiscount * (taxCfg.value||0) / 100)).toFixed(2);
      const discountAmount = +((preDiscount * (discountPercent/100))).toFixed(2);
      if (discountEl) discountEl.textContent = discountAmount.toFixed(2);
      if (taxEl) taxEl.textContent = tax.toFixed(2);
      const total = (preDiscount - discountAmount) + shipping + tax;
      totalEl.textContent = total.toFixed(2);
      const free = ((subtotal + addonsTotal) >= FREE_SHIP_THRESHOLD);
      document.getElementById('cart-freeship').style.display = free ? 'none' : 'block';
      const shipNote = document.getElementById('ship-note');
      shipNote.style.display = free ? 'none' : 'block';
      try { if (window.updateCartBadge) window.updateCartBadge(); } catch(_){}
    }

    // Global loader helpers
    function showGlobalLoader(){
      try { const el = document.getElementById('global-loader'); if (el) { el.style.display = 'flex'; document.body.style.overflow = 'hidden'; } } catch(_){}
    }
    function hideGlobalLoader(){
      try { const el = document.getElementById('global-loader'); if (el) { el.style.display = 'none'; document.body.style.overflow = ''; } } catch(_){}
    }
    function openSuccessModal(){
      try {
        const dlg = document.getElementById('success-dialog');
        if (!dlg) return;
        try { dlg.showModal(); } catch(_) { dlg.setAttribute('open',''); }
      } catch(_){}
    }
    if (applyPromoBtn) {
      applyPromoBtn.addEventListener('click', async ()=>{
        const code = (promoInput.value||'').trim();
        if (!code) {
          try { promoInput.classList.add('cart-invalid','cart-shake'); setTimeout(()=> promoInput.classList.remove('cart-shake'), 500); promoInput.scrollIntoView({behavior:'smooth', block:'center'}); promoInput.focus(); } catch(_){ }
          return;
        }
        try { promoInput.classList.remove('cart-invalid'); } catch(_){ }
        try {
          const amountBeforeTaxShip = Cart.total();
          const res = await fetch('promo.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ promoCode: code, totalAmount: amountBeforeTaxShip }) });
          const data = await res.json();
          if (data && data.success) {
            discountPercent = Number(data.discount||0);
            appliedPromo = code;
            render();
            // subtle success feedback
            try { applyPromoBtn.textContent = 'Applied'; setTimeout(()=> applyPromoBtn.textContent = 'Apply', 1200); } catch(_){ }
          } else {
            // show invalid state for wrong code
            try { promoInput.classList.add('cart-invalid','cart-shake'); setTimeout(()=> promoInput.classList.remove('cart-shake'), 500); } catch(_){ }
          }
        } catch(err){ try { promoInput.classList.add('cart-invalid','cart-shake'); setTimeout(()=> promoInput.classList.remove('cart-shake'), 500); } catch(_){} }
      });
    }
    // render initial
    render();
    // Instant add-to-cart for upsell Buy buttons in cart section (all devices) with loading state
    (function enableInstantUpsellAdd(){
      try {
        const buyLinks = document.querySelectorAll('.near_goods .btn_wrapperx a');
        if (!buyLinks || !buyLinks.length) return;
        const updateBadge = () => {
          const count = Cart.list().reduce((sum,item)=> sum + (item.qty||1), 0);
          document.querySelectorAll('[data-cart-count]').forEach(el=> el.textContent = String(count));
        };
        buyLinks.forEach(a=>{
          a.addEventListener('click', (e)=>{
            const href = a.getAttribute('href') || '';
            const url = new URL(href, location.origin);
            const product = url.searchParams.get('product');
            if (!product) return; // allow normal nav for unknown links
            e.preventDefault();
            // Loading state
            const textEl = a.querySelector('.text') || a;
            const prev = textEl.textContent;
            textEl.textContent = 'Adding...';
            a.setAttribute('aria-disabled','true');
            const prevStyle = a.getAttribute('style') || '';
            a.setAttribute('style', prevStyle + (prevStyle && !/;\s*$/.test(prevStyle) ? '; ' : '') + 'pointer-events:none; opacity:.7;');
            try {
              if (product === 'carsbag') {
                Cart.add({ product: 'carsbag', set: 'front', pattern: '', matColor: '#000000', trimColor: '#2b61c8', qty: 1, subtotal: ADDON_CARSBAG_PRICE });
              } else if (product === 'home') {
                Cart.add({ product: 'home', set: 'full', pattern: '', matColor: '#000000', trimColor: '#000000', qty: 1, subtotal: ADDON_HOME_PRICE });
              }
              render();
              updateBadge();
              textEl.textContent = 'Added';
            } catch(_) {
              textEl.textContent = prev || 'Buy';
            }
            // Restore interactivity after a short delay
            setTimeout(()=>{
              a.removeAttribute('aria-disabled');
              a.setAttribute('style', prevStyle);
              try { textEl.textContent = prev || 'Buy'; } catch(_) {}
            }, 1200);
          });
        });
      } catch(_) {}
    })();
    // PayPal button
    if (window.paypal) {
      paypal.Buttons({
        onClick: function(data, actions) {
          // Block checkout if cart is empty
          try {
            if (!Cart.list().length) {
              const tbl = document.querySelector('.basket-table');
              tbl && tbl.classList.add('cart-shake');
              setTimeout(()=> tbl && tbl.classList.remove('cart-shake'), 500);
              return actions.reject();
            }
          } catch(_){ }
          const agree = document.getElementById('agree-terms');
          const label = document.getElementById('agreement-label');
          // inline validation for agreement checkbox
          if (agree && !agree.checked) {
            try { label && label.classList.add('cart-invalid','cart-shake'); setTimeout(()=> label && label.classList.remove('cart-shake'), 500); } catch(_){ }
            try { label && label.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(_){ }
            return actions.reject();
          }
          try { label && label.classList.remove('cart-invalid'); } catch(_){ }
          return actions.resolve();
        },
        createOrder: function(data, actions) {
          const items = Cart.list();
          const subtotal = Cart.total();
          const shipping = +shipPriceEl.textContent;
          const addonsTotal = 0;
          const preDiscount = subtotal + addonsTotal;
          const discountAmount = +((preDiscount * (discountPercent/100))).toFixed(2);
          const tax = +( (((preDiscount) * (taxCfg.value||0)) / 100).toFixed(2) );
          const total = (preDiscount - discountAmount) + shipping + tax;
          return actions.order.create({
            application_context: { shipping_preference: 'GET_FROM_FILE' },
            purchase_units: [{
              amount: { value: total.toFixed(2), currency_code: 'CAD',
                breakdown: {
                  item_total: { value: (preDiscount).toFixed(2), currency_code: 'CAD' },
                  discount: { value: discountAmount.toFixed(2), currency_code: 'CAD' },
                  shipping: { value: shipping.toFixed(2), currency_code: 'CAD' },
                  tax_total: { value: tax.toFixed(2), currency_code: 'CAD' }
                }
              },
              items: items.map(i=>({
                name: (`${i.make} ${i.model} ${i.year} — ${i.set}` + (i.hybrid ? ' — hybrid' : '')).slice(0,127),
                unit_amount: { value: (i.subtotal||0).toFixed(2), currency_code: 'CAD' },
                quantity: String(i.qty||1)
              }))
            }]
          });
        },
        onApprove: function(data, actions) {
          try { showGlobalLoader(); } catch(_){}
          return actions.order.capture().then(async function(details) {
            const items = Cart.list();
            const subtotal = Cart.total();
            const shipping = +shipPriceEl.textContent;
            const addonsTotal = 0;
            const addons = [];
            const preDiscount = subtotal + addonsTotal;
            const discountAmount = +((preDiscount * (discountPercent/100))).toFixed(2);
            const tax = +( (((preDiscount) * (taxCfg.value||0)) / 100).toFixed(2) );
            const total = (preDiscount - discountAmount) + shipping + tax;
            let phone = (
              details?.payer?.phone?.phone_number?.national_number ||
              details?.payer?.phone?.national_number ||
              details?.purchase_units?.[0]?.shipping?.phone?.phone_number?.national_number ||
              details?.purchase_units?.[0]?.shipping?.phone_number ||
              ''
            );
            const orderNumber = (function(){
              const rnd = Math.floor(1000 + Math.random() * 9000);
              return `1010${rnd}`;
            })();
            const payload = {
              formName:'paypal',
              paypalOrderId: details.id,
              payerEmail: details.payer?.email_address || '',
              payerName: `${details.payer?.name?.given_name||''} ${details.payer?.name?.surname||''}`.trim(),
              phone,
              orderNumber,
              shipTo: {
                name: details.purchase_units?.[0]?.shipping?.name?.full_name || '',
                line1: details.purchase_units?.[0]?.shipping?.address?.address_line_1 || '',
                line2: details.purchase_units?.[0]?.shipping?.address?.address_line_2 || '',
                city: details.purchase_units?.[0]?.shipping?.address?.admin_area_2 || '',
                state: details.purchase_units?.[0]?.shipping?.address?.admin_area_1 || '',
                postal: details.purchase_units?.[0]?.shipping?.address?.postal_code || '',
                country: details.purchase_units?.[0]?.shipping?.address?.country_code || ''
              },
              items, subtotal, shipping, addons, addonsTotal, tax, total, discountPercent, discountAmount, promoCode: appliedPromo
            };
            try {
              await fetch('action.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            } catch(_) { }
            try { Cart.clear(); } catch(_) { }
            try { if (window.updateCartBadge) window.updateCartBadge(); } catch(_) { }
            try { rowsEl.innerHTML = ''; render(); } catch(_) { }
            // populate success modal email
            try {
              const emailEl = document.getElementById('success-email');
              if (emailEl) emailEl.textContent = String(payload?.payerEmail || details?.payer?.email_address || 'your email');
            } catch(_){ }
            try { hideGlobalLoader(); } catch(_){ }
            openSuccessModal();
          });
        },
        onCancel: function(){ try { hideGlobalLoader(); } catch(_){} },
        onError: function(){ try { hideGlobalLoader(); } catch(_){} }
      }).render('#paypal-button-container');
    }
    // Terms modal open/close
    (function(){
      const open = document.getElementById('open-terms');
      const dlg = document.getElementById('terms-dialog');
      const close = document.getElementById('close-terms');
      const succ = document.getElementById('success-dialog');
      const succClose = document.getElementById('close-success');
      if (open && dlg) {
        open.addEventListener('click', function(e){ e.preventDefault(); try { dlg.showModal(); } catch(_){ dlg.setAttribute('open',''); } });
      }
      if (close && dlg) {
        close.addEventListener('click', function(){ try { dlg.close(); } catch(_){ dlg.removeAttribute('open'); } });
      }
      if (succ && succClose) {
        succClose.addEventListener('click', function(){ try { succ.close(); } catch(_){ succ.removeAttribute('open'); } });
      }
    })();
  </script>
</body>
</html>


